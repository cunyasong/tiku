<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€æ¿æ€»æ§å° (æœ€ç»ˆç‰ˆ)</title>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --p: #2563eb; --bg: #f1f5f9; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        .side { width: 250px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .menu-item { padding: 15px 20px; cursor: pointer; color: #64748b; font-weight: 500; border-left: 4px solid transparent; }
        .menu-item:hover { background: #f8fafc; }
        .menu-item.active { background: #eff6ff; color: var(--p); border-left-color: var(--p); }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .panel { display: none; }
        .panel.active { display: block; }
        .box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; background: var(--p); }
        .btn-green { background: #10b981; } .btn-red { background: #ef4444; } .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        .tree-node { padding: 10px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; background: white; }
        /* ç™»å½•å±‚ */
        #login { position: fixed; inset: 0; background: white; z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-box { background: white; width: 500px; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

<!-- ç™»å½• -->
<div id="login">
    <h2>ğŸ”— è¿æ¥äº‘ç«¯åå°</h2>
    <div style="width:300px">
        <input id="appId" placeholder="AppID">
        <input id="appKey" type="password" placeholder="AppKey">
        <button class="btn" style="width:100%" onclick="conn()">è¿æ¥</button>
    </div>
</div>

<!-- ä¾§è¾¹æ  -->
<div class="side">
    <div style="padding:20px; font-size:18px; font-weight:bold; border-bottom:1px solid #eee;">ğŸ’¼ æ€»æ§å°</div>
    <div class="menu-item active" onclick="tab('content')">ğŸ“š é¢˜åº“å†…å®¹</div>
    <div class="menu-item" onclick="tab('config')">âš™ï¸ Appé…ç½®</div>
    <div class="menu-item" onclick="tab('codes')">ğŸ”‘ æ¿€æ´»ç ç®¡ç†</div>
    <div style="margin-top:auto; padding:20px;">
        <button class="btn" style="width:100%" onclick="saveAll()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
    </div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div class="main">
    <!-- 1. å†…å®¹ç®¡ç† -->
    <div id="p-content" class="panel active">
        <button class="btn btn-green" onclick="addRoot()">+ æ–°å»ºå¤§ç±»</button>
        <div id="tree" style="margin-top:20px"></div>
    </div>

    <!-- 2. Appé…ç½® -->
    <div id="p-config" class="panel">
        <div class="box">
            <h3>ğŸ“¢ é¦–é¡µå…¬å‘Š</h3>
            <input id="cfg-notice" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹ï¼ŒAppé¡¶éƒ¨ä¼šæ»šåŠ¨æ˜¾ç¤º">
        </div>
        <div class="box">
            <h3>ğŸ“„ è‡ªå®šä¹‰é¡µé¢ (å¡«è¡¥ä¸èƒ½æ”¹é¡µé¢çš„æ¼æ´)</h3>
            <p style="font-size:12px; color:#666">å¯ç”¨åï¼ŒAppåº•éƒ¨ä¼šå‡ºç°ç¬¬3ä¸ªæŒ‰é’®ã€‚</p>
            <input id="cfg-tab-title" placeholder="é¡µé¢åç§° (å¦‚: è€ƒè¯•é¡»çŸ¥)">
            <textarea id="cfg-tab-html" rows="5" placeholder="é¡µé¢å†…å®¹ (æ”¯æŒHTMLä»£ç )"></textarea>
        </div>
        <div class="box">
            <h3>ğŸ“ è”ç³»æ–¹å¼</h3>
            <input id="cfg-contact" placeholder="è¾“å…¥å¾®ä¿¡å·æˆ–ç”µè¯ï¼Œæ˜¾ç¤ºåœ¨'æˆ‘çš„'é¡µé¢">
        </div>
    </div>

    <!-- 3. æ¿€æ´»ç  -->
    <div id="p-codes" class="panel">
        <div class="box" style="background:#eff6ff; border-color:#bfdbfe">
            <h3>ğŸ’° ç”Ÿæˆæ¿€æ´»ç </h3>
            <label>è¯¾ç¨‹ID (å»é¢˜åº“é‡Œå¤åˆ¶çº¢è‰²çš„ID)</label>
            <input id="gen-target">
            <label>æœ‰æ•ˆæœŸ</label>
            <select id="gen-days">
                <option value="-1">æ°¸ä¹…æœ‰æ•ˆ</option>
                <option value="1">1å¤© (ä½“éªŒ)</option>
                <option value="7">7å¤© (å‘¨å¡)</option>
                <option value="30">30å¤© (æœˆå¡)</option>
                <option value="365">365å¤© (å¹´å¡)</option>
            </select>
            <label>æ•°é‡</label>
            <select id="gen-num"><option value="1">1ä¸ª</option><option value="10">10ä¸ª</option><option value="50">50ä¸ª</option></select>
            <button class="btn btn-green" onclick="doGen()">ğŸš€ ç”Ÿæˆå¹¶å¯¼å‡ºExcel</button>
        </div>
        <div class="box">
            <h3>ğŸ”§ å”®åè§£ç»‘</h3>
            <input id="reset-code" placeholder="è¾“å…¥å®¢æˆ·æ¿€æ´»ç ">
            <button class="btn btn-outline" onclick="resetDevice()">é‡ç½®è®¾å¤‡ç»‘å®š</button>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å¼¹çª— -->
<div class="modal" id="modal">
    <div class="modal-box">
        <h3>ç¼–è¾‘</h3>
        <input id="m-name" placeholder="åç§°">
        <select id="m-type" onchange="toggleImp()"><option value="folder">ğŸ“‚ æ–‡ä»¶å¤¹</option><option value="paper">ğŸ“„ è¯•å·</option></select>
        <input id="m-id" placeholder="ğŸ”’ æ”¶è´¹ID (å¦‚: vip1)ï¼Œä¸å¡«åˆ™å…è´¹">
        
        <div id="imp-box" style="display:none; border-top:1px solid #eee; padding-top:10px">
            <button class="btn btn-outline" onclick="dlTpl()">ä¸‹è½½Excelæ¨¡ç‰ˆ</button>
            <input type="file" onchange="impExcel(this)" accept=".xlsx" style="margin-top:10px">
            <p id="imp-msg" style="color:green; font-size:12px"></p>
        </div>

        <div style="margin-top:20px; text-align:right">
            <button class="btn btn-outline" onclick="document.getElementById('modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn" onclick="saveM()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    let appData = { list: [], config: {} }, curArr, isEd, edRef, tmpQs=[];
    
    function conn() {
        const id = document.getElementById('appId').value;
        const key = document.getElementById('appKey').value;
        if(!id) return;
        AV.init({ appId: id, appKey: key });
        load();
    }

    async function load() {
        try {
            const r = await new AV.Query('AppContent').descending('updatedAt').first();
            if(r && r.get('json')) appData = Array.isArray(r.get('json')) ? {list:r.get('json'), config:{}} : r.get('json');
            renderTree(); renderConfig();
            document.getElementById('login').style.display='none';
        } catch(e) { alert('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ID'); }
    }

    function tab(t) {
        document.querySelectorAll('.panel').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('p-'+t).classList.add('active');
        // event.target.classList.add('active');
    }

    // æ ‘æ¸²æŸ“
    function renderTree() {
        const box = document.getElementById('tree'); box.innerHTML='';
        const run = (arr, el) => {
            if(!arr) return;
            arr.forEach((it,i) => {
                const d = document.createElement('div');
                const isF = it.type === 'folder';
                d.innerHTML = `
                    <div class="tree-node">
                        <div><b style="color:${isF?'#2563eb':'#ef4444'}">${isF?'ğŸ“‚':'ğŸ“„'}</b> ${it.name} <span style="font-size:10px; color:#c2410c; background:#fff7ed">${it.id||''}</span></div>
                        <div>
                            ${it.id ? `<button onclick="toGen('${it.id}')" style="font-size:10px">å–ç </button>` : ''}
                            ${isF ? `<button onclick="add(this,${i})">+</button>` : ''}
                            <button onclick="edit(this,${i})">âœ</button>
                            <button onclick="del(this,${i})" style="color:red">Ã—</button>
                        </div>
                    </div>
                    <div class="sub" style="margin-left:20px; display:none"></div>
                `;
                d.querySelector('.tree-node').onclick = e => { if(e.target.tagName!='BUTTON') d.querySelector('.sub').style.display = d.querySelector('.sub').style.display=='none'?'block':'none' };
                d.querySelectorAll('button').forEach(b => b.pArr = arr);
                if(isF && it.children) run(it.children, d.querySelector('.sub'));
                el.appendChild(d);
            });
        };
        run(appData.list, box);
    }

    // å¢åˆ æ”¹
    function addRoot(){ curArr=appData.list; isEd=false; openM(); }
    window.add=(b,i)=>{ curArr=b.pArr[i].children=b.pArr[i].children||[]; isEd=false; openM(); }
    window.edit=(b,i)=>{ edRef=b.pArr[i]; isEd=true; openM(edRef); }
    window.del=(b,i)=>{ if(confirm('åˆ ?')) { b.pArr.splice(i,1); renderTree(); } }

    function openM(d){
        document.getElementById('m-name').value = d?d.name:'';
        document.getElementById('m-type').value = d?d.type:'folder';
        document.getElementById('m-id').value = d?(d.id||''):'';
        tmpQs = d && d.questions ? d.questions : [];
        toggleImp();
        document.getElementById('modal').style.display='flex';
        document.getElementById('imp-msg').innerText = `å½“å‰ ${tmpQs.length} é¢˜`;
    }
    function saveM(){
        const n = document.getElementById('m-name').value;
        const t = document.getElementById('m-type').value;
        const id = document.getElementById('m-id').value;
        const o = { name:n, type:t, id:id||undefined };
        if(t==='folder') o.children = (isEd && edRef.children) ? edRef.children : []; else o.questions = tmpQs;
        if(isEd) Object.assign(edRef, o); else curArr.push(o);
        renderTree(); document.getElementById('modal').style.display='none';
    }

    // é…ç½®
    function renderConfig(){
        const c = appData.config || {};
        document.getElementById('cfg-notice').value = c.notice||'';
        document.getElementById('cfg-tab-title').value = c.tabTitle||'';
        document.getElementById('cfg-tab-html').value = c.tabHtml||'';
        document.getElementById('cfg-contact').value = c.contact||'';
    }

    async function saveAll(){
        appData.config = {
            notice: document.getElementById('cfg-notice').value,
            tabTitle: document.getElementById('cfg-tab-title').value,
            tabHtml: document.getElementById('cfg-tab-html').value,
            contact: document.getElementById('cfg-contact').value
        };
        try {
            const r = new (AV.Object.extend('AppContent'))();
            r.set('json', appData);
            await r.save();
            alert('ğŸ‰ ä¿å­˜æˆåŠŸï¼ŒAppå·²æ›´æ–°ï¼');
        } catch(e) { alert('å¤±è´¥:'+e.message); }
    }

    // æ¿€æ´»ç 
    function toGen(id) { document.getElementById('gen-target').value = id; tab('codes'); }
    async function doGen() {
        const id = document.getElementById('gen-target').value;
        const days = parseInt(document.getElementById('gen-days').value);
        const num = parseInt(document.getElementById('gen-num').value);
        if(!id) return alert('å¡«ID');
        const objs=[], codes=[];
        for(let i=0; i<num; i++){
            let c = Math.random().toString(36).substr(2,8).toUpperCase();
            const r = new (AV.Object.extend('Invites'))();
            r.set('code',c); r.set('subjectId',id); r.set('duration',days); r.set('deviceIds',[]);
            objs.push(r);
            codes.push({'Code':c, 'Days':days, 'ID':id});
        }
        await AV.Object.saveAll(objs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(codes), "Sheet1");
        XLSX.writeFile(wb, "æ¿€æ´»ç .xlsx");
        alert('ç”ŸæˆæˆåŠŸ');
    }

    // Excel
    function toggleImp(){ document.getElementById('imp-box').style.display = document.getElementById('m-type').value==='paper'?'block':'none'; }
    function dlTpl(){ 
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["é¢˜ç›®","A","B","C","D","ç­”æ¡ˆ(A/B/C/D)","è§£æ"],["1+1=?","1","2","3","4","B","è§£æ"]]), "Sheet1");
        XLSX.writeFile(wb, "æ¨¡ç‰ˆ.xlsx");
    }
    function impExcel(ipt){
        const r = new FileReader();
        r.onload = e => {
            const arr = XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets['Sheet1'], {header:1});
            for(let i=1; i<arr.length; i++) if(arr[i][0]) tmpQs.push({
                q:arr[i][0], o:[arr[i][1]||'',arr[i][2]||'',arr[i][3]||'',arr[i][4]||''],
                a:{'A':0,'B':1,'C':2,'D':3}[(arr[i][5]||'A').trim().toUpperCase()]||0, r:arr[i][6]||''
            });
            document.getElementById('imp-msg').innerText = `å·²åŠ  ${tmpQs.length} é¢˜`;
        };
        r.readAsArrayBuffer(ipt.files[0]);
    }

    // é‡ç½®
    async function resetDevice(){
        const c = document.getElementById('reset-code').value;
        const q = new AV.Query('Invites'); q.equalTo('code',c);
        const r = await q.first();
        if(r) { r.set('deviceIds',[]); await r.save(); alert('å·²é‡ç½®'); } else alert('æœªæ‰¾åˆ°');
    }
</script>
</body>
</html>